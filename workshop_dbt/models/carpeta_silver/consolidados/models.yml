version: 2

models:
  - name: centros_consolidados
    description: "Tabla consolidada de centros comerciales con estrategia delete+insert"
    config:
      materialized: incremental
      unique_key: cod_centro
    columns:
      - name: cod_centro
        description: "Código único identificador del centro comercial (PK)"
        data_type: varchar(10)
        tests:
          - unique
          - not_null
      - name: nombre_centro
        description: "Nombre completo del centro comercial"
        data_type: varchar(100)
        tests:
          - not_null
      - name: ciudad
        description: "Ciudad donde se ubica el centro comercial"
        data_type: varchar(50)
        tests:
          - not_null
          - singular_validar_mayusculas
      - name: region
        description: "Región o comunidad autónoma del centro"
        data_type: varchar(50)
      - name: estado
        description: "Estado operativo del centro comercial"
        data_type: varchar(20)
        tests:
          - accepted_values:
              arguments:
                values: ['Activo', 'Inactivo', 'Mantenimiento']
      - name: ts_consolidacion
        description: "Timestamp de cuando se consolidó el registro en silver"
        data_type: timestamp

  - name: cabecera_tickets_consolidados
    description: "Tabla consolidada de cabeceras de tickets con estrategia merge"
    config:
      materialized: incremental
      unique_key: id_ticket
    columns:
      - name: id_ticket
        description: "Identificador único del ticket de venta (PK)"
        data_type: varchar(10)
        tests:
          - unique
          - not_null
      - name: cod_centro
        description: "Código del centro comercial donde se generó el ticket"
        data_type: varchar(10)
        tests:
          - not_null
      - name: fecha_ticket
        description: "Fecha en que se generó el ticket"
        data_type: date
        tests:
          - not_null
      - name: hora_ticket
        description: "Hora en que se generó el ticket"
        data_type: time
        tests:
          - not_null
      - name: total_ticket
        description: "Importe total del ticket en euros"
        data_type: decimal(10,2)
        tests:
          - not_null
      - name: metodo_pago
        description: "Método de pago utilizado en la transacción"
        data_type: varchar(20)
        tests:
          - not_null
      - name: empleado
        description: "Código identificador del empleado que atendió la venta"
        data_type: varchar(10)
        tests:
          - not_null
      - name: ts_consolidacion
        description: "Timestamp de cuando se consolidó el registro en silver"
        data_type: timestamp

  - name: lineas_tickets_consolidados
    description: "Tabla consolidada de líneas de tickets con estrategia merge"
    config:
      materialized: incremental
      unique_key: ['id_ticket', 'id_linea_ticket']
    columns:
      - name: id_ticket
        description: "Identificador del ticket al que pertenece la línea (PK parcial)"
        data_type: varchar(10)
        tests:
          - not_null
      - name: id_linea_ticket
        description: "Identificador único de la línea dentro del ticket (PK parcial)"
        data_type: integer
        tests:
          - not_null
      - name: id_ticket_linea
        description: "Clave única compuesta (id_ticket + id_linea_ticket)"
        data_type: varchar(21)
        tests:
          - unique
          - not_null
      - name: cod_producto
        description: "Código único del producto vendido"
        data_type: varchar(10)
        tests:
          - not_null
      - name: nombre_producto
        description: "Nombre descriptivo del producto"
        data_type: varchar(100)
        tests:
          - not_null
      - name: cantidad
        description: "Cantidad de unidades vendidas del producto"
        data_type: integer
        tests:
          - not_null
      - name: precio_unitario
        description: "Precio unitario del producto en euros"
        data_type: decimal(10,2)
        tests:
          - not_null
      - name: total_linea
        description: "Total de la línea (cantidad * precio_unitario)"
        data_type: decimal(10,2)
        tests:
          - not_null
      - name: ts_consolidacion
        description: "Timestamp de cuando se consolidó el registro en silver"
        data_type: timestamp

tests:
  - dbt_utils.unique_combination_of_columns:
      name: unique_ticket_linea_combination
      model: lineas_tickets_consolidados
      arguments:
        combination_of_columns:
          - id_ticket
          - id_linea_ticket